{% extends "base.html" %}

{% block title %}My Picks & Strategy - CFB Survivor Pool{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Add progress badge in top-right corner -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üìã My Picks & Strategy Center</h2>
        {% if current_week_display %}
            <div>
                {% if current_week_display.badge_type == 'playoff' %}
                    <span class="badge bg-danger fs-6">üèà {{ current_week_display.progress_text }}</span>
                {% else %}
                    <span class="badge bg-secondary fs-6">{{ current_week_display.progress_text }}</span>
                {% endif %}
            </div>
        {% endif %}
    </div>
    
    <!-- CFP Phase Alert (if applicable) -->
    {% if in_cfp %}
    <div class="alert alert-danger mb-3">
        <h5>üèà College Football Playoff Phase üèÜ</h5>
        <p class="mb-0">All teams have been reset! You can pick any team again, but once used in the CFP, they cannot be picked again in later CFP rounds.</p>
    </div>
    {% endif %}
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Picks</h5>
                    <h2>{{ total_picks }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body bg-success text-white">
                    <h5 class="card-title">Correct</h5>
                    <h2>{{ correct_picks }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body bg-danger text-white">
                    <h5 class="card-title">Incorrect</h5>
                    <h2>{{ incorrect_picks }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body bg-warning">
                    <h5 class="card-title">Cumulative Spread</h5>
                    <h2>{{ "%.1f"|format(current_user.cumulative_spread) }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Pick History Column -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4>üìú Pick History with Spread Tracking</h4>
                </div>
                <div class="card-body">
                    {% if user_picks %}
                        <!-- Regular Season Section -->
                        <h5 class="mb-3">Regular Season & Conference Championships (Weeks 1-15)</h5>
                        <table class="table table-striped table-sm mb-4">
                            <thead>
                                <tr>
                                    <th>Week</th>
                                    <th>Team Picked</th>
                                    <th>Conference</th>
                                    <th>Spread</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pick in user_picks %}
                                    {% if pick.week.week_number <= 15 %}
                                    <tr>
                                        <td>
                                            <strong>{{ pick.week_display.display_name if pick.week_display else 'Week ' + pick.week.week_number|string }}</strong>
                                            {% if pick.week.is_active %}
                                                <span class="badge bg-primary">Current</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ pick.team.name }}</td>
                                        <td><small class="text-muted">{{ pick.team.get_conference() }}</small></td>
                                        <td>
                                            {% if pick.spread_data %}
                                                {% if pick.spread_data.team_spread < 0 %}
                                                    <span class="text-success">{{ pick.spread_data.team_spread }}</span>
                                                {% elif pick.spread_data.team_spread > 0 %}
                                                    <span class="text-danger">+{{ pick.spread_data.team_spread }}</span>
                                                {% else %}
                                                    PK
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if pick.is_correct == True %}
                                                <span class="badge bg-success">‚úì Won</span>
                                            {% elif pick.is_correct == False %}
                                                <span class="badge bg-danger">‚úó Lost</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Pending</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        <!-- College Football Playoff Section -->
                        {% set playoff_picks = user_picks | selectattr('week.week_number', 'ge', 16) | list %}
                        {% if playoff_picks %}
                        <h5 class="mb-3 text-danger">üèà College Football Playoff (Weeks 16+)</h5>
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>Team Picked</th>
                                    <th>Spread</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pick in playoff_picks %}
                                <tr>
                                    <td>
                                        <strong>{{ pick.week_display.display_name if pick.week_display else 'Week ' + pick.week.week_number|string }}</strong>
                                        {% if pick.week.is_active %}
                                            <span class="badge bg-danger">Current</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ pick.team.name }}</td>
                                    <td>
                                        {% if pick.spread_data %}
                                            {% if pick.spread_data.team_spread < 0 %}
                                                <span class="text-success">{{ pick.spread_data.team_spread }}</span>
                                            {% elif pick.spread_data.team_spread > 0 %}
                                                <span class="text-danger">+{{ pick.spread_data.team_spread }}</span>
                                            {% else %}
                                                PK
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if pick.is_correct == True %}
                                            <span class="badge bg-success">‚úì Won</span>
                                        {% elif pick.is_correct == False %}
                                            <span class="badge bg-danger">‚úó Lost</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                        
                        <table class="table table-bordered mt-3">
                            <tfoot>
                                <tr class="table-info">
                                    <td colspan="3"><strong>Total Cumulative Spread:</strong></td>
                                    <td><strong>{{ "%.1f"|format(current_user.cumulative_spread) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div class="alert alert-info mt-2">
                            <small>
                                <strong>How spread points work:</strong><br>
                                ‚Ä¢ Picking favorites (negative spread) adds points to your total<br>
                                ‚Ä¢ Picking underdogs (positive spread) subtracts points from your total<br>
                                ‚Ä¢ Lower cumulative spread = better tiebreaker position
                            </small>
                        </div>
                    {% else %}
                        <p class="text-muted">No picks made yet.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Strategy Tips (Dynamic based on phase) -->
            <div class="card mt-3">
                <div class="card-body">
                    <h5>üí° Strategy Tips</h5>
                    <ul>
                        <li><strong>{{ available_teams|length }}</strong> teams available for {{ phase_description|default('future weeks') }}</li>
                        <li>Cumulative spread ({{ "%.1f"|format(current_user.cumulative_spread) }}) is the 2nd tiebreaker after lives remaining</li>
                        {% if not in_cfp %}
                        <li>You must pick a conference title game winner for conference championship week</li>
                        <li>You currently have coverage in <strong>{{ conferences_with_teams }}/{{ total_conferences }}</strong> conferences</li>
                        <li>See "Teams Available" to track options by conference üëÄ‚Üí</li>
                        {% endif %}
                        {% if in_cfp %}
                        <li class="text-danger"><strong>CFP Note:</strong> All teams have been reset! You can use any team again, but only once during the playoff.</li>
                        {% if cfp_teams_on_bye %}
                        <li><strong>{{ cfp_teams_on_bye|length }}</strong> team(s) on bye this round - they'll be available next round</li>
                        {% endif %}
                        {% else %}
                        <li>Available teams will reset once the CFP is set</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            <!-- Lives Status -->
            <div class="card mt-3">
                <div class="card-body">
                    <h5>Lives Remaining</h5>
                    <div class="d-flex align-items-center">
                        {% for i in range(current_user.lives_remaining) %}
                            <span style="font-size: 2rem;">‚ù§Ô∏è</span>
                        {% endfor %}
                        {% for i in range(2 - current_user.lives_remaining) %}
                            <span style="font-size: 2rem;">üñ§</span>
                        {% endfor %}
                        <span class="ms-3">
                            ({{ current_user.lives_remaining }} of 2 lives remaining)
                        </span>
                    </div>
                    {% if current_user.is_eliminated %}
                        <div class="alert alert-danger mt-2">
                            You have been eliminated from the pool.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Available Teams Column -->
        <div class="col-md-5">
            <!-- Available Teams Section -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 me-3 text-nowrap">üéØ {{ available_teams|length }} Teams Available</h4>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-xs btn-outline-light" id="toggleOddsButton" style="font-size: 0.75rem;">
                                Show Nat'l Title Odds
                            </button>
                            {% if not in_cfp %}
                            <button type="button" class="btn btn-xs btn-outline-light" id="toggleAllAccordion" style="font-size: 0.75rem;">
                                Expand All
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if in_cfp %}
                        <!-- CFP Mode: Show available teams, bye teams, and eliminated teams -->
                        
                        {% if available_teams %}
                            <h6 class="text-success mb-2">‚úÖ Available This Round ({{ available_teams|length }})</h6>
                            <div class="row mb-4">
                                {% for team in available_teams | sort(attribute='name') %}
                                    <div class="col-12 mb-2">
                                        <div class="badge bg-success w-100 p-2">
                                            {{ team.name }}{% if team.national_title_odds %}<span class="team-odds d-none"> ({{ team.national_title_odds }})</span>{% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning mb-3">
                                <strong>No teams available this round!</strong> You may have already picked all teams with games this week.
                            </div>
                        {% endif %}
                        
                        {% if cfp_teams_on_bye %}
                            <h6 class="text-info mb-2">‚è∏Ô∏è On Bye This Round ({{ cfp_teams_on_bye|length }})</h6>
                            <div class="row mb-4">
                                {% for team in cfp_teams_on_bye | sort(attribute='name') %}
                                    <div class="col-12 mb-2">
                                        <div class="badge bg-info w-100 p-2">
                                            {{ team.name }}{% if team.national_title_odds %}<span class="team-odds d-none"> ({{ team.national_title_odds }})</span>{% endif %} <small>(bye)</small>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        {% if cfp_eliminated_teams %}
                            <h6 class="text-danger mb-2">‚ùå Eliminated from Playoffs ({{ cfp_eliminated_teams|length }})</h6>
                            <p class="small text-muted mb-2">These teams lost and are no longer in the tournament</p>
                            <div class="row">
                                {% for team in cfp_eliminated_teams | sort(attribute='name') %}
                                    <div class="col-12 mb-2">
                                        <div class="badge bg-secondary w-100 p-2" style="text-decoration: line-through; opacity: 0.7;">
                                            {{ team.name }} <small>(eliminated)</small>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                    {% else %}
                        <!-- Regular season: Conference accordion -->
                        {% if teams_by_conference %}
                            <div class="accordion" id="conferenceAccordion">
                                {% for conf_name, teams in teams_by_conference.items() | sort %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                                            <button class="accordion-button collapsed"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#collapse{{ loop.index }}"
                                                    aria-expanded="false">
                                                <strong>{{ conf_name }}</strong>
                                                <span class="ms-auto me-2 badge bg-primary">{{ teams|length }} teams</span>
                                            </button>
                                        </h2>
                                        <div id="collapse{{ loop.index }}" 
                                             class="accordion-collapse collapse" 
                                             data-bs-parent="#conferenceAccordion">
                                            <div class="accordion-body">
                                                <div class="row">
                                                    {% for team in teams | sort(attribute='name') %}
                                                        <div class="col-12 mb-2">
                                                            <div class="badge bg-success w-100 p-2">
                                                                {{ team.name }}{% if team.national_title_odds %}<span class="team-odds d-none"> ({{ team.national_title_odds }})</span>{% endif %}
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <strong>No teams remaining!</strong> You've used all available teams for {{ phase_description|default('this phase') }}.
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            <!-- Conference Championship Alert Box (hide during CFP) -->
            {% if not in_cfp %}
            <div class="card conference-alert mb-3">
                <div class="card-body" style="background-color: #343a40;">
                    <h5 class="mb-3">üèÜ Conference Championship Coverage</h5>
                    
                    <div class="mb-2">
                        <strong>Coverage Status: {{ conferences_with_teams }}/{{ total_conferences }} conferences</strong>
                        {% if conferences_with_teams >= 8 %}
                            <span class="badge bg-success ms-2">Excellent</span>
                        {% elif conferences_with_teams >= 5 %}
                            <span class="badge bg-warning ms-2">Good</span>
                        {% else %}
                            <span class="badge bg-danger ms-2">Limited</span>
                        {% endif %}
                    </div>
                    
                    <div class="row mt-3">
                        {% for conf_name in conference_status %}
                            <div class="col-6">
                                {% if conference_status[conf_name]['count'] > 1 %}
                                    <span class="conference-coverage-good">‚úì</span>
                                {% elif conference_status[conf_name]['count'] == 1 %}
                                    <span class="conference-coverage-warning">‚ö†</span>
                                {% else %}
                                    <span class="conference-coverage-danger">‚úó</span>
                                {% endif %}
                                {{ conf_name }}
                                {% if conference_status[conf_name]['count'] == 1 %}
                                    <small class="text-warning">(1 left)</small>
                                {% elif conference_status[conf_name]['count'] == 0 %}
                                    <small class="text-danger">(depleted)</small>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if conference_warnings %}
                    <!-- Toggle Button (shown by default) -->
                    <div id="warningsToggleButton" class="mt-3">
                        <button type="button" class="btn btn-sm btn-outline-warning w-100" id="showWarningsBtn">
                            ‚ö†Ô∏è Show Warnings ({{ conference_warnings|length }})
                        </button>
                    </div>
                    
                    <!-- Warning Box (hidden by default) -->
                    <div id="warningsBox" class="alert alert-warning mt-3 mb-0" style="display: none;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="fw-bold">Conference Championship Risks:</small>
                            <button type="button" class="btn btn-sm btn-outline-dark" id="hideWarningsBtn">
                                Hide Warnings
                            </button>
                        </div>
                        <small>
                            {% for warning in conference_warnings %}
                                ‚Ä¢ {{ warning }}<br>
                            {% endfor %}
                        </small>
                    </div>
                    {% endif %}
                </div>
                <div class="mt-3 pt-2 border-top text-center">
                    <span class="text-white-50">üìä</span> 
                    <a href="https://www.ncaa.com/standings/football/fbs" target="_blank" class="text-white text-decoration-none fw-bold">
                        View NCAA Conference Standings ‚Üí
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- Used Teams Reference (with phase clarity) -->
            <div class="card mt-3">
                <div class="card-header bg-secondary text-white">
                    <h4>üö´ Teams Already Used {% if in_cfp %}(CFP Only){% endif %} ({{ used_teams|length }})</h4>
                </div>
                <div class="card-body">
                    {% if used_teams %}
                        <div class="row">
                            {% for item in used_teams | sort(attribute='week') %}
                            <div class="col-md-6 mb-2">
                                <div class="badge bg-secondary w-100 p-2" 
                                     title="Used in {{ item.week_display|default('Week ' + item.week|string) }}">
                                    {{ item.team.name }} ({{ item.week_display|default('W' + item.week|string) }})
                                    {% if item.is_correct == True %}
                                        ‚úì
                                    {% elif item.is_correct == False %}
                                        ‚úó
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No teams used yet{% if in_cfp %} in the CFP{% endif %}.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Expand All/Collapse All functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleAccordionButton = document.getElementById('toggleAllAccordion');
    const toggleOddsButton = document.getElementById('toggleOddsButton');
    const accordionItems = document.querySelectorAll('#conferenceAccordion .accordion-collapse');
    let allExpanded = false;
    let oddsVisible = false;

    if (toggleOddsButton) {
        toggleOddsButton.textContent = "Show Nat'l Title Odds";
        document.querySelectorAll('.team-odds').forEach(function(span) {
            span.classList.toggle('d-none', !oddsVisible);
        });
        toggleOddsButton.addEventListener('click', function() {
            oddsVisible = !oddsVisible;
            document.querySelectorAll('.team-odds').forEach(function(span) {
                span.classList.toggle('d-none', !oddsVisible);
            });
            toggleOddsButton.textContent = oddsVisible ? "Hide Odds" : "Show Nat'l Title Odds";
        });
    }

    // Only set up accordion toggle if accordion exists (regular season)
    if (toggleAccordionButton && accordionItems.length > 0) {
        toggleAccordionButton.addEventListener('click', function() {
            if (allExpanded) {
                // Collapse all
                accordionItems.forEach(function(item) {
                    item.classList.remove('show');
                });
                document.querySelectorAll('#conferenceAccordion .accordion-button').forEach(function(button) {
                    button.classList.add('collapsed');
                    button.setAttribute('aria-expanded', 'false');
                });
                toggleAccordionButton.textContent = 'Expand All';
                allExpanded = false;
            } else {
                // Expand all
                accordionItems.forEach(function(item) {
                    item.classList.add('show');
                });
                document.querySelectorAll('#conferenceAccordion .accordion-button').forEach(function(button) {
                    button.classList.remove('collapsed');
                    button.setAttribute('aria-expanded', 'true');
                });
                toggleAccordionButton.textContent = 'Collapse All';
                allExpanded = true;
            }
        });

        // Update button text based on accordion state when items are manually toggled
        document.querySelectorAll('#conferenceAccordion .accordion-button').forEach(function(button) {
            button.addEventListener('click', function() {
                setTimeout(function() {
                    const expandedCount = document.querySelectorAll('#conferenceAccordion .accordion-collapse.show').length;
                    const totalCount = accordionItems.length;

                    if (expandedCount === totalCount) {
                        toggleAccordionButton.textContent = 'Collapse All';
                        allExpanded = true;
                    } else if (expandedCount === 0) {
                        toggleAccordionButton.textContent = 'Expand All';
                        allExpanded = false;
                    } else {
                        toggleAccordionButton.textContent = 'Expand All';
                        allExpanded = false;
                    }
                }, 350); // Wait for accordion animation
            });
        });
    }
});

// Warning box toggle functionality
const showWarningsBtn = document.getElementById('showWarningsBtn');
const hideWarningsBtn = document.getElementById('hideWarningsBtn');
const warningsToggleButton = document.getElementById('warningsToggleButton');
const warningsBox = document.getElementById('warningsBox');

if (showWarningsBtn && hideWarningsBtn) {
    showWarningsBtn.addEventListener('click', function() {
        warningsToggleButton.style.display = 'none';
        warningsBox.style.display = 'block';
    });

    hideWarningsBtn.addEventListener('click', function() {
        warningsBox.style.display = 'none';
        warningsToggleButton.style.display = 'block';
    });
}

</script>
{% endblock %}
